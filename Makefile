# Copyright 2009 Anders Fugmann.
# Distributed under the GNU General Public License v3
#
# This file is part of Borderline - A Firewall Generator
#
# Borderline is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# Borderline is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Borderline.  If not, see <http://www.gnu.org/licenses/>.

CP=cp

.PHONY: autogen install tests

INSTALL_BASE ?= .

PACKAGES = unix str num oUnit
BUILD_DIR = _build
BIN_DIR = $(INSTALL_BASE)/bin
DOC_DIR = $(INSTALL_BASE)/doc
TARGET = optimized
OCFLAGS = -annot -g
#-w @A
INCLUDE = src

SOURCES = $(wildcard src/*.ml src/*.mli src/*.mll src/*.mly) 

BINARIES = src/borderline \
	   src/bl_configure \
           src/unit_test

LEX_FILES = src/lexer.mll
YACC_FILES = src/parser.mly 

include makefile.mk

OCAMLRUNPARAM=b
export OCAMLRUNPARAM=b

.DEFAULT_GOAL := unittest

unittest: install
	@$(BIN_DIR)/unit_test

# Standard goal. 
test: install
	@$(MAKE) -C configuration autogenerated
#	@$(BIN_DIR)/bl_configure --force --output configuration/zones
	@$(BIN_DIR)/borderline configuration/borderline.bl


/etc/default/borderline:
	@echo "MAIN=/etc/borderline/borderline.bl" > $@

# This is kinda a global installation. Do we want that?
dist: install 
	[ -d $(INSTALL_BASE)/etc/init.d/ ] || mkdir -p $(INSTALL_BASE)/etc/init.d/
	$(CP) borderline.sh $(INSTALL_BASE)/etc/init.d/borderline
#	[ -x `which update-rc.d`  ] && update-rc.d borderline defaults

clean::
	@$(MAKE) -C configuration clean
	@$(RM) -fr *~

tests: install
	@cd tests; BORDERLINE=../$(BIN_DIR)/borderline ./test.sh
