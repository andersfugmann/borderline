# Copyright 2009 Anders Fugmann.
# Distributed under the GNU General Public License v3
#
# This file is part of Borderline - A Firewall Generator
#
# Borderline is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# Borderline is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Borderline.  If not, see <http://www.gnu.org/licenses/>.

CP=cp

.PHONY: autogen install tests

default: $(BINARIES)

PACKAGES = unix str num
BUILD_DIR = _build
DIST_DIR = bin
DOC_DIR = doc
OPTIMIZED = true
OCFLAGS = -annot -g
#-w @A
INCLUDE = src

SOURCES = $(wildcard src/*.ml src/*.mli src/*.mll src/*.mly) 

BINARIES = src/borderline \
	   src/configure

OCAMLRUNPARAM=b
export OCAMLRUNPARAM=b

default: install

test: configure borderline
	./configure --force --output ../configuration/zones
	./borderline ../configuration/borderline.bl

include makefile.mk

default: borderline autogen bl-configure
	@echo "Now do a 'sudo make install'"

autogen:
	$(MAKE) -C configuration autogenerated

borderline:
	$(MAKE) -C src borderline-native
	$(CP) -L src/borderline-native borderline

bl-configure:
	$(MAKE) -C src configure
	$(CP) -L src/configure bl-configure

/etc/default/borderline:
	echo "MAIN=/etc/borderline/borderline.bl" > $@

deploy: borderline bl-configure autogen /etc/default/borderline

	mkdir -p /etc/borderline /etc/borderline/zones /etc/borderline/generic
	$(CP) borderline /usr/local/sbin/
	$(CP) bl-configure /usr/local/sbin/
	$(CP) borderline.sh /etc/init.d/borderline
	$(CP) configuration/*.bl /etc/borderline
	$(CP) -av configuration/zones/*.bl /etc/borderline/zones/
	$(CP) -av configuration/generic/*.bl /etc/borderline/generic/

	[ -x `which update-rc.d`  ] && update-rc.d borderline defaults

#clean::
	#$(MAKE) -C configuration clean
	#$(RM) -f borderline bl-configure
	#$(RM) -fr *~

tests:
	cd tests; ./test.sh
