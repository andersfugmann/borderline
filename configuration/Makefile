.DEFAULT_GOAL := autogenerated

DESTDIR ?= .

CP = cp

AUTOGENERATED = generic/protocols.bl generic/services.bl generic/allocated.bl

.PHONY: autogenerated install
autogenerated: $(AUTOGENERATED)
generic/protocols.bl generic/services.bl generic/bogon.bl generic/allocated.bl: Makefile

generic/protocols.bl: /etc/protocols
	@echo "Gen     :" $@
	@egrep -v "^#" $< | while read name number rest; do \
          for n in $${name} $${rest%#*}; do \
            echo "define \"$${n}\" = $${number}"; \
          done; \
        done | sort -u > $@

generic/services.bl: /etc/services
	@echo "Gen     :" $@
	@egrep -v "^#" $< | while read name number rest; do \
          if [ "$${number##*/}" = "tcp" -o "$${number##*/}" = "udp" ]; then \
	    for n in $${name} $${rest%#*}; do \
              echo "define \"$${n}\" = $${number%%/*}"; \
            done; \
          fi; \
        done | sort -u > $@

generic/allocated.bl: URL = http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xml
#generic/allocated.bl: URL = file:///tmp/ipv6-unicast-address-assignments.xml
generic/allocated.bl: allocations.xslt
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define \"allocated\" = " >> $@
	@xsltproc $< $(URL) >> $@

generic/bogon.bl: URL = http://www.team-cymru.org/services.html/Bogons/fullbogons-ipv6.txt
generic/bogon.bl:
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define \"bogon\" = " >> $@
	@curl -s $(URL) | grep -v "^#" | sed 's/$$/,/g' >> $@

clean:
	@find . -name \*~ | xargs $(RM)
	@$(RM) $(AUTOGENERATED)

install: autogenerated
	[ -d $(DESTDIR)/etc/borderline/zones/ ] || mkdir -p $(DESTDIR)/etc/borderline/zones/
	[ -d $(DESTDIR)/etc/borderline/generic/ ] || mkdir -p $(DESTDIR)/etc/borderline/generic/
	$(CP) *.bl $(DESTDIR)/etc/borderline
	$(CP) -av zones/*.bl $(DESTDIR)/etc/borderline/zones/
	$(CP) -av generic/*.bl $(DESTDIR)/etc/borderline/generic/

.PHONY: force
force:
