.DEFAULT_GOAL := autogenerated

DESTDIR ?= .

CP = cp

AUTOGENERATED = generic/services.bl generic/allocated6.bl generic/bogon6.bl generic/bogon4.bl

.PHONY: autogenerated install
autogenerated: $(AUTOGENERATED)
$(AUTOGENERATED): Makefile

generic/services.bl: /etc/services
	@echo "Gen     :" $@
	@egrep -v "^#" $< | while read name number rest; do \
          if [ "$${number##*/}" = "tcp" -o "$${number##*/}" = "udp" ]; then \
	    for n in $${name} $${rest%#*}; do \
              echo "define \"$${n}\" += $${number%%/*}"; \
            done; \
          fi; \
        done | sort -u > $@

generic/allocated6.bl: URL = http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xml
generic/allocated6.bl: allocations.xslt
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define \"allocated6\" = " >> $@
	@xsltproc $< $(URL) >> $@

generic/bogon6.bl: URL = http://www.team-cymru.org/Services/Bogons/fullbogons-ipv6.txt
generic/bogon6.bl:
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define \"bogon6\" = " >> $@
	@curl -s $(URL) | grep -v "^#" | sed 's/$$/,/g' >> $@

generic/bogon4.bl: URL = http://www.team-cymru.org/Services/Bogons/fullbogons-ipv4.txt
generic/bogon4.bl:
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define \"bogon4\" = " >> $@
	@curl -s $(URL) | grep -v "^#" | sed 's/$$/,/g' >> $@

clean:
	@find . -name \*~ | xargs $(RM)
	@$(RM) $(AUTOGENERATED)

install: autogenerated
	[ -d $(DESTDIR)/etc/borderline/zones/ ] || mkdir -p $(DESTDIR)/etc/borderline/zones/
	[ -d $(DESTDIR)/etc/borderline/generic/ ] || mkdir -p $(DESTDIR)/etc/borderline/generic/
	$(CP) *.bl $(DESTDIR)/etc/borderline
	$(CP) -av zones/*.bl $(DESTDIR)/etc/borderline/zones/
	$(CP) -av generic/*.bl $(DESTDIR)/etc/borderline/generic/

.PHONY: force
force:
