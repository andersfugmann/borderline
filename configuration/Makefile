.DEFAULT_GOAL := autogenerated

INSTALL_BASE ?= .

.PHONY: autogenerated install
autogenerated: generic/protocols.bl generic/services.bl generic/bogon.bl generic/allocated.bl

generic/protocols.bl: /etc/protocols
	@echo "Gen     :" $@
	@egrep -v "^#" $< | while read name number rest; do \
          if [ -n "$${name}" ]; then \
            echo "define $${name} = $${number}"; \
          fi; \
        done | uniq > $@

generic/services.bl: /etc/services
	@echo "Gen     :" $@
	@egrep -v "^#" $< | while read name number rest; do \
          if [ -n "$${name}" ] && [ "$${number##*/}" = "tcp" -o "$${number##*/}" = "udp" ]; then \
            echo "define $${name} = $${number%%/*}"; \
          fi; \
        done | uniq > $@

#generic/allocated.bl: URL = http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xml
generic/allocated.bl: URL = file:///tmp/ipv6-unicast-address-assignments.xml
generic/allocated.bl: allocations.xslt force
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define allocated = " >> $@
	@xsltproc $< $(URL) >> $@

#generic/bogon.bl: URL = http://www.cymru.com/Bogons/v6bogon.html
generic/bogon.bl: URL = file:///tmp/fullbogons-ipv6.txt
generic/bogon.bl: force
	@echo "Gen     :" $@
	@echo "#Extracted from $(URL)" > $@
	@echo -n "define bogon = " >> $@
	@curl -s $(URL) | grep -v "^#" | sed 's/$$/,/g' >> $@

clean:
	@find . -name \*~ | xargs $(RM)
	@$(RM) $(autogenerated)

install: autogenerated
	[ -d $(INSTALL_BASE)/etc/borderline/zones/ ] || mkdir -p $(INSTALL_BASE)/etc/borderline/zones/	
	[ -d $(INSTALL_BASE)/etc/borderline/generic/ ] || mkdir -p $(INSTALL_BASE)/etc/borderline/generic/
	$(CP) *.bl $(INSTALL_PREFIX)/etc/borderline
	$(CP) -av zones/*.bl $(INSTALL_PREFIX)/etc/borderline/zones/
	$(CP) -av generic/*.bl $(INSTALL_PREFIX)/etc/borderline/generic/

.PHONY: force
force:
