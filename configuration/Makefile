BORDERLINE=../src/main

BOGON_URL = http://www.cymru.com/Bogons/v6bogon.html

ALL: main.screen

.PHONY: autogenerated
autogenerated: generic/protocols.bl generic/services.bl generic/bogon.bl

generic/protocols.bl: /etc/protocols
	@egrep -v "^#" $< | while read name number rest; do \
                              if [ -n "$${name}" ]; then \
                                 echo "define $${name} = $${number}"; \
                              fi; \
                           done | uniq > $@

generic/services.bl: /etc/services
	@egrep -v "^#" $< | while read name number rest; do \
                              if [ -n "$${name}" ] && [ "$${number##*/}" = "tcp" -o "$${number##*/}" = "udp" ]; then \
                                 echo "define $${name} = $${number%%/*}"; \
                              fi; \
                           done | uniq > $@

generic/bogon.bl: LINES=$(shell wget -q -O- $(BOGON_URL) | egrep ".*:.*:.*")
generic/bogon.bl: force
	@echo "#Extracted from $(BOGON_URL)" > $@
	@echo "define bogon = " >> $@
	@echo $(LINES) | sed 's/\s/, /g' >> $@

main.bl: autogenerated

main.out: main main.bl
	OCAMLRUNPARAM=b $(BORDERLINE) main.bl > $@

.PHONY: main.screen

main.screen: main.out
	@cat main.out

main.sh: main.out
	echo "ip6tables -F;  ip6tables -X; ip6tables -Z" > $@
	grep "ip6tables" $< >> $@
	chmod a+x main.sh


.PHONY: main

main:
	$(MAKE) -C ../src main

clean:
	@find . -name \*~ | xargs $(RM)
	@$(RM) $(autogenerated)


.PHONY: force
force:
