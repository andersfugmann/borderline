# Copyright 2009 Anders Fugmann.
# Distributed under the GNU General Public License v3
#
# This file is part of Borderline - A Firewall Generator
#
# Borderline is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# Borderline is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Borderline.  If not, see <http://www.gnu.org/licenses/>.
BORDERLINE=../src/borderline

BOGON_URL = http://www.cymru.com/Bogons/v6bogon.html

ALL: borderline.screen

.PHONY: autogenerated
autogenerated: generic/protocols.bl generic/services.bl generic/bogon.bl

generic/protocols.bl: /etc/protocols
	@egrep -v "^#" $< | while read name number rest; do \
                              if [ -n "$${name}" ]; then \
                                 echo "define $${name} = $${number}"; \
                              fi; \
                           done | uniq > $@

generic/services.bl: /etc/services
	@egrep -v "^#" $< | while read name number rest; do \
                              if [ -n "$${name}" ] && [ "$${number##*/}" = "tcp" -o "$${number##*/}" = "udp" ]; then \
                                 echo "define $${name} = $${number%%/*}"; \
                              fi; \
                           done | uniq > $@

# MAybe we should use this instead: http://www.iana.org/assignments/ipv6-unicast-address-assignments/
generic/bogon.bl: LINES=$(shell wget -q -O- $(BOGON_URL) | egrep ".*:.*:.*")
generic/bogon.bl: force
	@echo "#Extracted from $(BOGON_URL)" > $@
	@echo "define bogon = " >> $@
	@echo $(LINES) | sed 's/\s/, /g' >> $@

borderline.bl: autogenerated

borderline.out: borderline borderline.bl
	OCAMLRUNPARAM=b $(BORDERLINE) borderline.bl > $@

.PHONY: borderline.screen

borderline.screen: borderline.out
	@cat borderline.out

borderline.sh: borderline.out
	echo "ip6tables -F;  ip6tables -X; ip6tables -Z" > $@
	grep "ip6tables" $< >> $@
	chmod a+x borderline.sh


.PHONY: borderline

borderline:
	$(MAKE) -C ../src borderline

clean:
	@find . -name \*~ | xargs $(RM)
	@$(RM) $(autogenerated)


.PHONY: force
force:
