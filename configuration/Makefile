.DEFAULT_GOAL := autogenerated
SHELL := /bin/bash

DESTDIR ?= .

CP = cp

AUTOGENERATED = generic/services.bl \
		generic/allocated6.bl \
		generic/bogon4.bl \
		generic/bogon6.bl \
		generic/l4proto.bl generic/states.bl \
		generic/iana-ipv4-special-registry.bl \
		generic/iana-ipv6-special-registry.bl

.PHONY: autogenerated install
autogenerated: $(AUTOGENERATED)
$(AUTOGENERATED): Makefile

generic/services.bl: /etc/services
	@echo "Gen     :" $@
	@egrep -v "^#" $< | while read name number rest; do \
          if [ "$${number##*/}" = "tcp" -o "$${number##*/}" = "udp" ]; then \
	    for n in $${name}; do \
              echo "define \"$${n}\" += [ $${number%%/*} ]"; \
            done; \
          fi; \
        done | sort -u > $@


generic/iana-ipv%-special-registry.bl: URL = https://www.iana.org/assignments/iana-ipv$*-special-registry/iana-ipv$*-special-registry.xml
generic/iana-ipv%-special-registry.bl: iana-special_registry.xslt
	@echo "Gen     :" $@
	@echo "# Extracted from $(URL)" > $@
	@xsltproc --stringparam prefix ipv$*_iana iana-special_registry.xslt <(curl -s $(URL)) >> $@

generic/allocated6.bl: URL = http://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xml
generic/allocated6.bl: allocations.xslt
	@echo "Gen     :" $@
	@echo "# Extracted from $(URL)" > $@
	@echo -n "define \"allocated6\" = [ " >> $@
	@xsltproc allocations.xslt <(curl -s $(URL)) >> $@
	@echo -n " ]" >> $@

generic/bogon%.bl: URL = https://www.team-cymru.org/Services/Bogons/fullbogons-ipv$*.txt
generic/bogon%.bl:
	@echo "Gen     :" $@
	@echo "# Extracted from $(URL)" > $@
	@echo -n "define \"bogon$*\" = [ " >> $@
	@curl -s $(URL) | grep -v "^#" | sed 's/$$/,/g' >> $@
	@echo -n " ]" >> $@


generic/l4proto.bl:
	@echo "Gen     :" $@
	@echo "# Extracted from 'nft describe meta l4proto'" > $@
	@/usr/sbin/nft describe meta l4proto | \
          tail -n +2 | \
          while read name id; do \
            echo "define $${name} = $${id}"; # $${id}\
          done >> $@

generic/states.bl:
	@echo "Gen     :" $@
	@echo "# Extracted from 'nft describe ct state'" > $@
	@/usr/sbin/nft describe ct state | \
          tail -n +4 | \
          while read name id; do \
            echo "define $${name} = \"$${name}\""; \
          done >> $@

clean:
	@find . -name \*~ | xargs $(RM)
	@$(RM) $(AUTOGENERATED)

.PHONY: install
install: autogenerated
	mkdir -p $(DESTDIR)/etc/borderline/zones/
	mkdir -p $(DESTDIR)/etc/borderline/generic/
	mkdir -p $(DESTDIR)/etc/borderline/conf.d

	$(CP) *.bl $(DESTDIR)/etc/borderline
	$(CP) -av zones/*.bl $(DESTDIR)/etc/borderline/zones/
	$(CP) -av generic/*.bl $(DESTDIR)/etc/borderline/generic/

.PHONY: force
force:
